# ==============================================================================
# metafile.yaml â€” Exemplo completo do formato suportado pelo Newpkg
# Local padrÃ£o: /usr/ports/<categoria>/<pacote>/metafile.yaml
# ==============================================================================

# ğŸ·ï¸ Nome e versÃ£o do pacote
name: example              # Nome do pacote
version: 1.0.0             # VersÃ£o atual
release: 1                 # Incrementa a cada rebuild
epoch: 0                   # NÃºmero de epoch (caso precise forÃ§ar upgrade)

# ğŸ“¦ Categoria e descriÃ§Ã£o
category: utils            # Categoria no /usr/ports
summary: "Exemplo completo de pacote para o Newpkg"
description: |
  Este Ã© um pacote de exemplo que demonstra todas as opÃ§Ãµes
  suportadas no formato de metafile.yaml do Newpkg. Ele cobre
  fases de build, patch, hooks, dependÃªncias e estÃ¡gios especiais.

# ğŸ§© EstÃ¡gio de construÃ§Ã£o
#   - normal â†’ instala em /
#   - pass1  â†’ instala em /mnt/lfs com usuÃ¡rio lfs
#   - pass2  â†’ instala em /mnt/lfs apÃ³s toolchain inicial
stage: normal

# âš™ï¸ Ambiente do build
environment:
  CC: gcc
  CXX: g++
  CFLAGS: "-O2 -pipe"
  CXXFLAGS: "-O2 -pipe"
  LDFLAGS: "-Wl,-O1,--as-needed"
  PKG_CONFIG_PATH: "/usr/lib/pkgconfig:/usr/share/pkgconfig"
  PATH: "/usr/bin:/bin:/usr/sbin:/sbin"
  LANG: "en_US.UTF-8"
  MAKEFLAGS: "-j$(nproc)"

# ğŸŒ Fontes (pode listar mÃºltiplos mirrors)
source:
  - https://ftp.gnu.org/gnu/hello/hello-2.12.tar.gz
  - https://mirror.example.org/hello-2.12.tar.gz

# ğŸ§¾ Sums de integridade (opcional, pode ser sha256/sha512/md5)
checksums:
  sha256: 31e7b1e1ef00e784bc1bafbb3f61e62c7cde4a4e3de8cfb1db4e97a1ef3a49e7

# ğŸ“¦ Nome da pasta gerada apÃ³s extraÃ§Ã£o (opcional)
build_dir: hello-2.12

# ğŸ“œ Patches aplicados automaticamente (ordem importa)
patches:
  - fix-locale.patch
  - disable-tests.patch

# âš’ï¸ Comandos de build (customizados)
# Se nÃ£o forem definidos, o core.sh tentarÃ¡ usar "./configure && make"
build:
  - ./configure --prefix=/usr --sysconfdir=/etc
  - make

# ğŸ“¥ Comandos de instalaÃ§Ã£o
# Se nÃ£o definidos, o core.sh usa "make DESTDIR=\$DESTDIR install"
install:
  - make DESTDIR=$DESTDIR install
  - install -v -m755 hello /usr/bin/hello

# ğŸ“‚ Arquivo de configuraÃ§Ã£o (gerado antes do build, se necessÃ¡rio)
# Pode ser usado para criar arquivos temporÃ¡rios de build.
config_files:
  - path: config.mk
    content: |
      PREFIX = /usr
      CFLAGS = -O2 -pipe

# ğŸ§· DependÃªncias
# SÃ£o resolvidas automaticamente pelo mÃ³dulo deps.py
depends:
  build:
    - gcc
    - make
    - coreutils
  runtime:
    - glibc
    - bash

# ğŸ§© DependÃªncias opcionais
optional_depends:
  - texinfo
  - man-db

# ğŸ§° Ferramentas exigidas apenas em bootstrap (pass1/pass2)
bootstrap_tools:
  - binutils
  - gcc
  - bash

# âš™ï¸ Arquivos de hooks especÃ­ficos deste pacote (executados se existirem)
# Estes scripts devem estar dentro de /usr/ports/<pkg>/scripts/
hooks:
  pre_download:   scripts/pre-download.sh
  post_download:  scripts/post-download.sh
  pre_build:      scripts/pre-build.sh
  post_build:     scripts/post-build.sh
  pre_install:    scripts/pre-install.sh
  post_install:   scripts/post-install.sh
  pre_remove:     scripts/pre-remove.sh
  post_remove:    scripts/post-remove.sh

# ğŸ” Testes pÃ³s-build (executados se existir target "check" no Makefile)
test:
  - make check || true

# ğŸ§¹ Limpeza extra apÃ³s instalaÃ§Ã£o (executada no DESTDIR)
cleanup:
  - rm -rf $DESTDIR/usr/share/doc/hello

# ğŸ§© UsuÃ¡rio/grupo a ser criado durante a instalaÃ§Ã£o
users:
  - name: example
    uid: 3001
    gid: 3001
    home: /var/lib/example
    shell: /sbin/nologin

groups:
  - name: example
    gid: 3001

# ğŸ“¦ Arquivos de pÃ³s-instalaÃ§Ã£o (executados fora do chroot)
post_install_actions:
  - update-desktop-database || true
  - ldconfig || true

# ğŸ—‚ï¸ DiretÃ³rios para preservar em upgrade/removal
preserve_paths:
  - /etc/example.conf
  - /var/lib/example/

# ğŸ”’ PolÃ­ticas de seguranÃ§a especÃ­ficas do pacote
security:
  sandbox: true          # Executa em ambiente isolado
  restricted_network: true
  drop_privileges: true
  forbid_root_build: false

# ğŸ§± Testes adicionais de integridade
integrity:
  check_symlinks: true
  check_permissions: true
  fix_on_error: true

# ğŸ“¦ Empacotamento
package:
  format: tar.zst        # Formato final (tar.zst, tar.xz, etc.)
  compression_level: 19
  include_docs: true
  include_manpages: true
  include_locales: false
  output_dir: /var/cache/newpkg/packages

# ğŸ§¾ InformaÃ§Ãµes extras
metadata:
  maintainer: "Fernando Canata <fernando@example.org>"
  license: GPL-3.0-or-later
  homepage: https://www.gnu.org/software/hello/
  repository: https://github.com/fernando/newpkg-ports
  bugtracker: https://github.com/fernando/newpkg-ports/issues
